# Nginx 配置示例 - Weekly Wrapped Newsletter Backend
# 
# 使用方法：
# 1. 复制此文件到 /etc/nginx/sites-available/weekly-wrapped
# 2. 修改 server_name 和证书路径
# 3. 创建软链接：sudo ln -s /etc/nginx/sites-available/weekly-wrapped /etc/nginx/sites-enabled/
# 4. 测试配置：sudo nginx -t
# 5. 重新加载：sudo systemctl reload nginx

# HTTP -> HTTPS 重定向
server {
    listen 80;
    listen [::]:80;
    server_name weekly.yourdomain.com;

    # Let's Encrypt ACME Challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 重定向到 HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS 主配置
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name weekly.yourdomain.com;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/weekly.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/weekly.yourdomain.com/privkey.pem;
    
    # SSL 配置（推荐的安全设置）
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    
    # 现代 SSL 协议
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/weekly.yourdomain.com/chain.pem;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 日志
    access_log /var/log/nginx/weekly-wrapped-access.log;
    error_log /var/log/nginx/weekly-wrapped-error.log;
    
    # 客户端上传大小限制
    client_max_body_size 20M;
    
    # 代理到 Docker 容器
    location / {
        proxy_pass http://localhost:8081;
        
        # 代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # 超时设置
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 缓冲设置
        proxy_buffering off;
        proxy_request_buffering off;
    }
    
    # 健康检查端点（可以不需要认证）
    location /healthz {
        proxy_pass http://localhost:8081/healthz;
        access_log off;
    }
    
    location /readyz {
        proxy_pass http://localhost:8081/readyz;
        access_log off;
    }
    
    # API 文档（生产环境可以考虑限制访问）
    location /docs {
        proxy_pass http://localhost:8081/docs;
        # 可选：限制访问
        # allow 10.0.0.0/8;  # 允许内网
        # deny all;          # 拒绝其他
    }
    
    location /redoc {
        proxy_pass http://localhost:8081/redoc;
        # 可选：限制访问
    }
}

# 可选：如果需要同时配置 TikTok Wrapped，可以添加另一个 server 块
# 
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name tee.yourdomain.com;
#     
#     # SSL 证书（可以使用同一个或不同的证书）
#     ssl_certificate /etc/letsencrypt/live/tee.yourdomain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/tee.yourdomain.com/privkey.pem;
#     
#     # ... 其他 SSL 配置 ...
#     
#     location / {
#         proxy_pass http://localhost:8080;  # 注意：TikTok Wrapped 使用 8080
#         # ... 其他代理配置 ...
#     }
# }
